#!/usr/bin/python
# -*- coding: iso-8859-1 -*-
# From sebsauvage : http://sebsauvage.net/python/snyppets/index.html#quickcodecoverage
# convert .cover file in html file
import os,glob,cgi

def cover2html(directory=''):
    ''' Converts .cover files generated by the Python Trace module to .html files.
        You can generate cover files this way:
            import trace,sys
            tracer = trace.Trace(ignoredirs=[sys.prefix, sys.exec_prefix],trace=0,count=1,outfile=r'./coverage_dir/counts')
            tracer.run('main()')
            r = tracer.results()
            r.write_results(show_missing=True, coverdir=r'./coverage_dir')

        Input:
            directory (string): The directory where the *.cover files are located.

        Output:
            None
            The html files are written in the input directory.

        Example:
            cover2html('coverage_dir')
    '''
    # Note: This function is a quick & dirty hack.

    # Write the CSS file:
    file = open("style.css","w+")
    file.write('''
body {
    font-family:"Trebuchet MS",Verdana,"DejaVuSans","VeraSans",Arial,Helvetica,sans-serif;
    font-size: 10pt;
    background-color: white;
    }
.noncovered { background-color:#ffcaca; }
.covered { }
td,th { padding-left:5px;
        padding-right:5px;
        border: 1px solid #ccc;
        font-family:"DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;
        font-size: 8pt;
   }
th { font-weight:bold; background-color:#eee;}
table { border-collapse: collapse; }
    ''')
    file.close()


    indexHtml = ""  # Index html table.

    # Convert each .cover file to html.
    for filename in glob.glob(os.path.join(directory,'*.cover')):
        print "Processing %s" % filename
        filein = open(filename,'r')
        htmlTable = '<table><thead><th>Run count</th><th>Line nÂ°</th><th>Code</th></thead><tbody>'
        linecounter = 0
        noncoveredLineCounter = 0
        for line in filein:
            linecounter += 1
            runcount = ''
            if line[5] == ':': runcount = cgi.escape(line[:5].strip())
            cssClass = 'covered'
            if line.startswith('>>>>>>'):
                noncoveredLineCounter += 1
                cssClass="noncovered"
                runcount = '&#x25ba;'
            htmlTable += '<tr class="%s"><td align="right">%s</td><td align="right">%d</td><td nowrap>%s</td></tr>\n' % (cssClass,runcount,linecounter,cgi.escape(line[7:].rstrip()).replace(' ','&nbsp;'))
        filein.close()
        htmlTable += '</tbody></table>'
        sourceFilename = filename[:-6]+'.py'
        coveragePercent = int(100*float(linecounter-noncoveredLineCounter)/float(linecounter))
        html = '''<html><!-- Generated by cover2html.py - http://sebsauvage.net --><head><link rel="stylesheet" href="style.css" type="text/css"></head><body>
<b>File:</b> %s<br>
<b>Coverage:</b> %d%% &nbsp; ( <span class="noncovered">&nbsp;&#x25ba;&nbsp;</span> = Code not executed. )<br>
<br>
        ''' % (cgi.escape(sourceFilename),coveragePercent) + htmlTable + '</body></html>'
        fileout = open(filename+'.html','w+')
        fileout.write(html)
        fileout.close()
        indexHtml += '<tr><td><a href="%s">%s</a></td><td>%d%%</td></tr>\n' % (filename+'.html',cgi.escape(sourceFilename),coveragePercent)

    # Then write the index:
    print "Writing index.html"
    file = open('index.html','w+')
    file.write('''<html><head><link rel="stylesheet" href="style.css" type="text/css"></head>
<body><table><thead><th>File</th><th>Coverage</th></thead><tbody>%s</tbody></table></body></html>''' % indexHtml)
    file.close()

    print "Done."


cover2html()
